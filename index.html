<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBTI T/F 분석기</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* 인트로 페이지 스타일 */
        .intro-page {
            text-align: center;
            padding: 2rem;
        }

        .main-title {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 2rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .start-button {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-button:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }

        /* 횟수 선택 라디오 버튼 스타일 */
        .count-selection {
            display: none;
            margin-top: 2rem;
        }

        .radio-group {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .setting-group {
            margin: 1.5rem 0;
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .setting-group h3 {
            margin: 0 0 1rem 0;
            color: #333;
            font-size: 1.1rem;
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 0.8rem 0;
        }

        .setting-row label {
            font-weight: 500;
            color: #555;
            min-width: 80px;
        }

        .setting-row select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            font-size: 1rem;
            min-width: 120px;
        }

        .refresh-button {
            padding: 0.5rem 1rem;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .refresh-button:hover {
            background-color: #1976D2;
            transform: scale(1.05);
        }

        /* 질문 페이지 스타일 */
        .question-page {
            display: none;
        }

        .character-container {
            text-align: center;
            margin-bottom: 2rem;
        }

        .character {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .face {
            width: 200px;
            height: 200px;
            position: relative;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* 눈 스타일 */
        .eyes {
            display: flex;
            justify-content: space-between;
            width: 100px;
            position: absolute;
            top: 50px;
            left: 30px;
        }

        .eye {
            width: 20px;
            height: 20px;
            background: #333;
            border-radius: 50%;
            position: relative;
        }

        /* 입 스타일 */
        .mouth {
            width: 80px;
            height: 40px;
            position: absolute;
            bottom: 40px;
            left: 40px;
            border: 4px solid #333;
            border-radius: 0 0 40px 40px;
            border-top: 0;
            transition: all 0.3s ease;
        }

        /* 표정 변화 클래스 */
        .face-very-angry {
            background-image: url('images/Very_angry.png');
        }

        .face-angry {
            background-image: url('images/Simple_angry.png');
        }

        .face-neutral {
            background-image: url('images/Base.png');
        }

        .face-happy {
            background-image: url('images/Simple_happy.png');
        }

        .face-very-happy {
            background-image: url('images/Very_happy.png');
        }

        .speech-bubble {
            position: relative;
            background: #ffffff;
            border-radius: 1rem;
            padding: 1rem;
            margin: 1rem;
            border: 2px solid #333;
        }

        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 0;
            border: 20px solid transparent;
            border-top-color: #ffffff;
            border-bottom: 0;
            margin-left: -20px;
            margin-bottom: -20px;
        }

        .input-container {
            margin-top: 2rem;
            text-align: center;
        }

        .answer-input {
            width: 80%;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .submit-button {
            padding: 0.8rem 1.5rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-button:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }

        .next-button {
            padding: 0.8rem 1.5rem;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 1rem;
            transition: all 0.3s ease;
            display: none;
        }

        .next-button:hover {
            background-color: #1976D2;
            transform: scale(1.05);
        }

        /* 버튼 컨테이너 */
        .button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1rem;
        }

        /* 결과 리뷰 아이콘 */
        .review-icon {
            display: none;
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: #2196F3;
            border-radius: 50%;
            cursor: pointer;
            color: white;
            text-align: center;
            line-height: 50px;
        }

        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            margin: 50px auto;
            overflow-y: auto;
            box-sizing: border-box;
        }

        /* 모달 스크롤바 스타일링 */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* 모달 내용이 많을 때를 위한 추가 스타일 */
        @media (max-height: 600px) {
            .modal-content {
                max-height: 90vh;
                margin: 20px auto;
            }
        }

        /* 로딩 스피너 애니메이션 */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 최종 결과 페이지 스타일 */
        .final-page {
            display: none;
            text-align: center;
        }

        .final-result {
            margin: 2rem 0;
        }

        .result-graph {
            width: 100%;
            height: 200px;
            background-color: #f0f0f0;
            margin: 1rem 0;
            border-radius: 10px;
        }

        .result-review {
            margin: 2rem 0;
            line-height: 1.6;
        }

        /* 키워드 차트 스타일 */
        .keyword-chart {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .keyword-category {
            margin-bottom: 1.5rem;
        }

        .keyword-category h4 {
            margin: 0 0 0.8rem 0;
            font-size: 1.1em;
            color: #2c3e50;
        }

        .keyword-bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 0.6rem;
            padding: 0.4rem 0;
        }

        .keyword-label {
            width: 100px;
            font-size: 0.9em;
            color: #555;
            text-align: right;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .keyword-bar-bg {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .keyword-bar {
            height: 100%;
            border-radius: 10px;
            position: relative;
            transition: width 0.8s ease;
        }

        .keyword-bar.t-type {
            background: linear-gradient(90deg, #ff6b6b, #ff8e53);
        }

        .keyword-bar.f-type {
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
        }

        .keyword-count {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 인트로 페이지 -->
        <div class="intro-page" id="introPage">
            <h1 class="main-title">MBTI T/F 성향 분석기</h1>
            <button class="start-button" id="startButton" onclick="showCountSelection()">시작하기</button>
            <div class="count-selection" id="countSelection">
                <h2>분석 설정을 선택하세요</h2>
                
                <!-- 분석 횟수 선택 -->
                <div class="setting-group">
                    <h3>분석 횟수</h3>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="count" value="1" checked> 1회
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="count" value="3"> 3회
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="count" value="5"> 5회
                        </label>
                    </div>
                </div>
                
                <!-- 질문 소스 선택 -->
                <div class="setting-group">
                    <h3>질문 타입</h3>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="questionSource" value="default" checked> 인터넷 밈(json하드코딩)
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="questionSource" value="ai"> AI 맞춤형(Gemini 연동) 
                        </label>
                    </div>
                </div>
                
                <!-- AI 질문 설정 (AI 선택 시에만 표시) -->
                <div class="setting-group" id="aiSettings" style="display: none;">
                    <h3>AI 질문 설정</h3>
                    <div class="setting-row">
                        <label>난이도:</label>
                        <select name="difficulty" id="difficultySelect">
                            <option value="easy">쉬움</option>
                            <option value="medium" selected>보통</option>
                            <option value="hard">어려움</option>
                        </select>
                    </div>
                    <div class="setting-row">
                        <label>질문 개수:</label>
                        <select name="questionCount" id="questionCountSelect">
                            <option value="3">3개</option>
                            <option value="5" selected>5개</option>
                            <option value="7">7개</option>
                            <option value="10">10개</option>
                        </select>
                    </div>
                    <button class="refresh-button" onclick="generateNewQuestions()" style="margin-top: 0.5rem;">
                        🔄 새 질문 생성
                    </button>
                </div>
                
                <button class="start-button" onclick="startAnalysis()" style="margin-top: 1rem;">분석 시작</button>
            </div>
        </div>

        <!-- 질문 페이지 -->
        <div class="question-page" id="questionPage">
            <div class="character-container">
                <div class="character">
                    <div class="face face-neutral" id="characterFace"></div>
                </div>
                <div class="speech-bubble">
                    <div id="question">질문이 여기에 표시됩니다.</div>
                    <div id="resultGraph" style="display: none;"></div>
                </div>
            </div>
            <div class="input-container">
                <input type="text" class="answer-input" id="answerInput" placeholder="답변을 입력하세요...">
                <div class="button-container">
                    <button class="submit-button" id="submitButton" onclick="submitAnswer()">답변 제출</button>
                    <button class="next-button" id="nextButton" onclick="nextQuestion()">다음 질문</button>
                </div>
                <div id="loadingMessage" style="display:none; color:#2196F3; font-weight:bold; margin-top:1rem;">
                    <span id="loadingText">AI가 분석중입니다</span><span id="loadingDots"></span>
                </div>
            </div>
            <div class="review-icon" id="reviewIcon" onclick="showReview()">📋</div>
        </div>

        <!-- 최종 결과 페이지 -->
        <div class="final-page" id="finalPage">
            <h1>최종 분석 결과</h1>
            <div id="finalOneLiner"></div>
            <div id="finalGraph"></div>
            <div id="finalReview"></div>
            <button onclick="location.reload()" class="start-button">다시 분석하기</button>
        </div>

        <!-- 리뷰 모달 -->
        <div class="modal" id="reviewModal" onclick="closeReview()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <h2>답변 리뷰</h2>
                <div id="reviewContent"></div>
                <button onclick="closeReview()" class="start-button" style="margin-top: 1rem;">닫기</button>
            </div>
        </div>

        <!-- 최종 결과 페이지 -->
        <div class="final-page" id="finalPage">
            <h2>최종 분석 결과</h2>
            <div class="final-result">
                <p id="finalOneLiner"></p>
                <div class="result-graph" id="finalGraph"></div>
                <div id="finalCharacter"></div>
                <div class="result-review" id="finalReview"></div>
            </div>
        </div>
    </div>

    <script>
        // API 기본 URL 설정
        const API_BASE_URL = 'http://localhost:8000';
        
        // 전역 변수
        let currentCount = 0;
        let maxCount = 0;
        let results = [];
        let usedQuestions = new Set(); // 사용된 질문들을 추적
        let currentQuestionIndex = 0;
        let questions = [];
        let answers = [];
        let totalQuestions = 0;

        // 질문 데이터 로드
        async function loadQuestions() {
            try {
                const response = await fetch(`${API_BASE_URL}/questions`);
                console.log('서버 응답:', response);
                const data = await response.json();
                console.log('받은 데이터:', data);
                questions = data.questions;
                totalQuestions = questions.length;
                displayQuestion();
            } catch (error) {
                console.error('질문을 불러오는데 실패했습니다:', error);
                document.getElementById('question').textContent = '질문을 불러오는데 실패했습니다. 서버가 실행 중인지 확인해주세요.';
            }
        }

        // 시작 버튼 클릭 시
        document.getElementById('startButton').addEventListener('click', function() {
            document.getElementById('startButton').style.display = 'none';
            document.getElementById('countSelection').style.display = 'block';
        });

        // 질문 표시
        function displayQuestion() {
            if (currentQuestionIndex < totalQuestions) {
                document.getElementById('question').textContent = questions[currentQuestionIndex];
            }
        }

        // 다음 질문으로 이동
        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < totalQuestions) {
                displayQuestion();
                const answerInput = document.getElementById('answerInput');
                answerInput.value = '';
                answerInput.disabled = false;  // 입력 필드 활성화
                document.getElementById('nextButton').style.display = 'none';
                document.getElementById('submitButton').style.display = 'inline-block';
                document.getElementById('submitButton').disabled = false;  // 제출 버튼 활성화
                document.getElementById('resultGraph').style.display = 'none';
            } else {
                // 모든 질문이 끝났을 때
                finishQuestions();
            }
        }

        // 답변 제출
        async function submitAnswer() {
            const answerInput = document.getElementById('answerInput');
            const answer = answerInput.value.trim();
            
            if (answer === '') {
                alert('답변을 입력해주세요.');
                document.getElementById('loadingMessage').style.display = 'none'; // 로딩 메시지 숨김
                return;
            }

            // 아래 fetch 및 결과 표시 코드는 임시로 주석 처리
            /*
            answerInput.disabled = true;
            document.getElementById('submitButton').disabled = true;

            setTimeout(async () => {
                try {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    const response = await fetch(`${API_BASE_URL}/analyze`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ text: answer })
                    });
                    const result = await response.json();
                    const tfScore = result.score;
                    if (result.prompt) {
                        console.log('[Gemini 프롬프트]', result.prompt);
                    }
                    // 결과 그래프 표시
                    const resultGraph = document.getElementById('resultGraph');
                    resultGraph.innerHTML = `
                        <div style=\"margin-top: 20px;\">
                            <div>T/F 성향 점수: ${tfScore.toFixed(1)}</div>
                            <div style=\"background: #eee; height: 20px; width: 100%; margin-top: 10px;\">
                                <div style=\"background: #4CAF50; height: 100%; width: ${tfScore}%;\"></div>
                            </div>
                            <div style=\"display: flex; justify-content: space-between; margin-top: 5px;\">
                                <span>T형</span>
                                <span>F형</span>
                            </div>
                        </div>
                    `;
                    resultGraph.style.display = 'block';
                    
                    updateCharacterExpression(tfScore);
                    
                    // 입력 필드와 버튼 상태 업데이트
                    answerInput.disabled = true;  // 현재 답변 입력 비활성화
                    document.getElementById('submitButton').style.display = 'none';
                    document.getElementById('nextButton').style.display = 'inline-block';
                    // 분석중 메시지 0.5초 후 자연스럽게 숨김
                    setTimeout(() => {
                        document.getElementById('loadingMessage').style.display = 'none';
                        document.getElementById('submitButton').disabled = false;
                    }, 500);
                } catch (error) {
                    console.error('Error:', error);
                    alert('답변 분석 중 오류가 발생했습니다.');
                    answerInput.disabled = false;  // 오류 발생 시 입력 필드 다시 활성화
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('submitButton').disabled = false;
                }
            }, 0);
            */
        }

        // 모든 질문이 끝났을 때
        function finishQuestions() {
            const questionContainer = document.querySelector('.question-page');
            questionContainer.innerHTML = `
                <h2>모든 질문이 완료되었습니다!</h2>
                <div class="final-results">
                    <h3>당신의 답변 기록:</h3>
                    ${answers.map((answer, index) => `
                        <div class="answer-record">
                            <p><strong>Q${index + 1}:</strong> ${questions[index]}</p>
                            <p><strong>A:</strong> ${answer}</p>
                        </div>
                    `).join('')}
                </div>
                <button onclick="location.reload()" class="start-button">다시 시작하기</button>
            `;
        }

        // 캐릭터 초기화
        function initCharacter() {
            const character = document.getElementById('characterFace');
            if (character) {
                character.className = 'face face-neutral';
            }
        }

        // 표정 변경
        function updateCharacterExpression(score) {
            const face = document.getElementById('characterFace');
            if (face) {
            face.className = 'face'; // 기존 클래스 제거

            if (score < 20) {
                face.classList.add('face-very-angry');
            } else if (score < 40) {
                face.classList.add('face-angry');
            } else if (score < 60) {
                face.classList.add('face-neutral');
            } else if (score < 80) {
                face.classList.add('face-happy');
            } else {
                face.classList.add('face-very-happy');
                }
            }
        }

        // 시작 버튼 클릭 시 횟수 선택 표시
        function showCountSelection() {
            document.getElementById('countSelection').style.display = 'block';
        }

        // 질문 데이터 로드
        async function loadQuestions() {
            try {
                const selectedSource = document.querySelector('input[name="questionSource"]:checked');
                
                let url = `${API_BASE_URL}/questions`;
                let params = new URLSearchParams();
                
                if (selectedSource && selectedSource.value === 'ai') {
                    // AI 질문 설정
                    const difficulty = document.getElementById('difficultySelect').value;
                    const count = parseInt(document.getElementById('questionCountSelect').value);
                    
                    params.append('use_ai', 'true');
                    params.append('difficulty', difficulty);
                    params.append('count', count.toString());
                } else {
                    // 기본 질문 사용
                    params.append('use_ai', 'false');
                }
                
                const response = await fetch(`${url}?${params}`);
                const data = await response.json();
                questions = data.questions;
                
                console.log(`질문 로드 완료: ${data.source || 'unknown'} 소스에서 ${questions.length}개 질문`);
                
                showNextQuestion();
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('질문을 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 랜덤 질문 선택
        function getRandomQuestion() {
            const availableQuestions = questions.filter((_, index) => !usedQuestions.has(index));
            if (availableQuestions.length === 0) {
                usedQuestions.clear();
                return questions[Math.floor(Math.random() * questions.length)];
            }
            const randomIndex = Math.floor(Math.random() * availableQuestions.length);
            const questionIndex = questions.findIndex(q => q === availableQuestions[randomIndex]);
            usedQuestions.add(questionIndex);
            return availableQuestions[randomIndex];
        }

        // 답변 제출
        async function submitAnswer() {
            const answer = document.getElementById('answerInput').value.trim();
            if (!answer) {
                alert('답변을 입력해주세요.');
                document.getElementById('loadingMessage').style.display = 'none'; // 로딩 메시지 숨김
                return;
            }

            document.getElementById('loadingMessage').style.display = 'block';
            startLoadingDots(); // 로딩 점 애니메이션 시작

            try {
                // API 호출
                const response = await fetch(`${API_BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: answer })
                });

                if (!response.ok) {
                    throw new Error('API 호출 실패');
                }

                const data = await response.json();
                // detailed_analysis 등 상세 분석 결과도 저장
                results.push({
                    question: document.getElementById('question').textContent,
                    answer: answer,
                    score: data.score,
                    detailed_analysis: data.detailed_analysis,
                    reasoning: data.reasoning,
                    suggestions: data.suggestions,
                    alternative_response: data.alternative_response
                });

                showResult(data.score);
                // currentCount++;
            } catch (error) {
                console.error('Error:', error);
                alert('분석 중 오류가 발생했습니다. 다시 시도해주세요.');
                document.getElementById('loadingMessage').style.display = 'none'; // 로딩 메시지 숨김
                stopLoadingDots(); // 로딩 점 애니메이션 중지
            }
        }

        // 다음 질문으로 이동
        function nextQuestion() {
            currentCount++;
            
            if (currentCount >= maxCount) {
                showFinalResult();
                return;
            }

            // 입력 필드 초기화
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').disabled = false;
            document.getElementById('resultGraph').style.display = 'none';
            document.querySelector('.submit-button').disabled = false;
            document.querySelector('.submit-button').style.opacity = '1';
            document.getElementById('nextButton').style.display = 'none';
            
            // 리뷰 아이콘 숨기기
            document.getElementById('reviewIcon').style.display = 'none';
            
            showNextQuestion();
        }

        // 분석 시작
        function startAnalysis() {
            const selectedCount = document.querySelector('input[name="count"]:checked');
            if (!selectedCount) {
                alert('횟수를 선택해주세요.');
                return;
            }

            const selectedSource = document.querySelector('input[name="questionSource"]:checked');
            if (!selectedSource) {
                alert('질문 타입을 선택해주세요.');
                return;
            }

            maxCount = parseInt(selectedCount.value);
            currentCount = 0;
            results = [];
            usedQuestions.clear(); // 사용된 질문 목록 초기화

            document.getElementById('introPage').style.display = 'none';
            document.getElementById('questionPage').style.display = 'block';
            initCharacter();
            // showNextQuestion(); // 이 부분은 새로운 로직으로 대체됨
            loadQuestions(); // 질문 데이터 로드
        
        // AI 설정 표시/숨김 이벤트 리스너 추가
        document.addEventListener('DOMContentLoaded', function() {
            const questionSourceRadios = document.querySelectorAll('input[name="questionSource"]');
            questionSourceRadios.forEach(radio => {
                radio.addEventListener('change', toggleAISettings);
            });
        });

        // AI 설정 표시/숨김 토글
        function toggleAISettings() {
            const selectedSource = document.querySelector('input[name="questionSource"]:checked');
            const aiSettings = document.getElementById('aiSettings');
            
            if (selectedSource && selectedSource.value === 'ai') {
                aiSettings.style.display = 'block';
            } else {
                aiSettings.style.display = 'none';
            }
        }

        // 새로운 AI 질문 생성
        async function generateNewQuestions() {
            const difficulty = document.getElementById('difficultySelect').value;
            const count = parseInt(document.getElementById('questionCountSelect').value);
            
            try {
                const response = await fetch(`${API_BASE_URL}/generate_questions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        count: count,
                        difficulty: difficulty
                    })
                });
                
                if (!response.ok) {
                    throw new Error('AI 질문 생성 실패');
                }
                
                const data = await response.json();
                questions = data.questions;
                
                alert(`새로운 ${difficulty} 난이도의 ${count}개 질문이 생성되었습니다!`);
                
            } catch (error) {
                console.error('Error generating questions:', error);
                alert('AI 질문 생성 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        }
        }

        // 다음 질문 표시
        function showNextQuestion() {
            if (currentCount >= maxCount) {
                showFinalResult();
                return;
            }

            const question = getRandomQuestion();
            document.getElementById('question').textContent = question;
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').disabled = false;
            document.getElementById('resultGraph').style.display = 'none';
            document.getElementById('reviewIcon').style.display = 'none';
            
            // 버튼 상태 초기화
            document.querySelector('.submit-button').disabled = false;
            document.querySelector('.submit-button').style.opacity = '1';
            document.getElementById('nextButton').style.display = 'none';
        }

        // 답변 제출
        async function submitAnswer() {
            const answer = document.getElementById('answerInput').value.trim();
            if (!answer) {
                alert('답변을 입력해주세요.');
                document.getElementById('loadingMessage').style.display = 'none'; // 로딩 메시지 숨김
                return;
            }

            document.getElementById('loadingMessage').style.display = 'block';
            startLoadingDots(); // 로딩 점 애니메이션 시작

            try {
                // API 호출
                const response = await fetch(`${API_BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: answer })
                });

                if (!response.ok) {
                    throw new Error('API 호출 실패');
                }

                const data = await response.json();
                // detailed_analysis 등 상세 분석 결과도 저장
                results.push({
                    question: document.getElementById('question').textContent,
                    answer: answer,
                    score: data.score,
                    detailed_analysis: data.detailed_analysis,
                    reasoning: data.reasoning,
                    suggestions: data.suggestions,
                    alternative_response: data.alternative_response
                });

                showResult(data.score);
                // currentCount++;
            } catch (error) {
                console.error('Error:', error);
                alert('분석 중 오류가 발생했습니다. 다시 시도해주세요.');
                document.getElementById('loadingMessage').style.display = 'none'; // 로딩 메시지 숨김
                stopLoadingDots(); // 로딩 점 애니메이션 중지
            }
        }

        // 결과 표시
        function showResult(tfScore) {
            const resultGraph = document.getElementById('resultGraph');
            resultGraph.style.display = 'block';
            
            updateCharacterExpression(tfScore);
            
            // T와 F의 비율 계산 (항상 T = 100-tfScore, F = tfScore)
            const tPercentage = 100 - tfScore;
            const fPercentage = tfScore;
            
            // 그래프 표시 (텍스트와 수치 표현)
            let resultText = '';
            if (tfScore < 20) resultText = `당신은 확실한 T입니다! "너 T발C야?" (T: ${tPercentage}% / F: ${fPercentage}%)`;
            else if (tfScore <= 40) resultText = `당신은 T 성향이 강합니다. (T: ${tPercentage}% / F: ${fPercentage}%)`;
            else if (tfScore >= 41 && tfScore <= 59) resultText = `당신은 T와 F의 균형이 잘 잡혀있습니다. (T: ${tPercentage}% / F: ${fPercentage}%)`;
            else if (tfScore < 80) resultText = `당신은 F 성향이 강합니다. (T: ${tPercentage}% / F: ${fPercentage}%)`;
            else resultText = `당신은 확실한 F입니다! "너 F구나?" (T: ${tPercentage}% / F: ${fPercentage}%)`;

            resultGraph.innerHTML = `
                <p style="margin: 1rem 0; font-size: 1.2em; font-weight: bold;">${resultText}</p>
                <div style="position: relative; width: 100%; margin: 2rem 0;">
                    <div style="width: 100%; height: 40px; background: linear-gradient(to right, #ff4444, #ffff44, #44ff44); border-radius: 20px; position: relative;">
                        <div style="width: 4px; height: 50px; background: black; position: absolute; left: ${tfScore}%; top: -5px;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 1.1em;">
                        <div style="text-align: left; width: 45%; background: rgba(255,68,68,0.1); padding: 10px; border-radius: 10px;">
                            <span style="font-weight: bold; color: #ff4444;">Thinking: ${tPercentage}%</span>
                        </div>
                        <div style="text-align: right; width: 45%; background: rgba(68,255,68,0.1); padding: 10px; border-radius: 10px;">
                            <span style="font-weight: bold; color: #44ff44;">Feeling: ${fPercentage}%</span>
                        </div>
                    </div>
                </div>
            `;

            // 답변 제출 버튼 비활성화 및 다음 버튼 표시
            document.querySelector('.submit-button').disabled = true;
            document.querySelector('.submit-button').style.opacity = '0.5';
            document.getElementById('nextButton').style.display = 'inline-block';
            document.getElementById('answerInput').disabled = true;
            
            // 리뷰 아이콘 표시
            document.getElementById('reviewIcon').style.display = 'block';
            // 분석중 메시지 항상 숨김
            document.getElementById('loadingMessage').style.display = 'none';
            stopLoadingDots(); // 로딩 점 애니메이션 중지
        }

        // 리뷰 표시
        function showReview() {
            const modal = document.getElementById('reviewModal');
            const content = document.getElementById('reviewContent');
            // 항상 최신 답변 리뷰를 참조하도록 인덱스 수정
            const idx = results.length - 1;
            // 디버깅 정보 출력
            console.log('showReview 호출 - idx:', idx, 'results 길이:', results?.length, 'results:', results);
            // 안전성 검사: 유효한 결과가 있는지 확인
            if (!results || results.length === 0 || idx < 0) {
                content.innerHTML = `
                    <div class="review-section">
                        <h3>리뷰 없음</h3>
                        <p>아직 분석된 답변이 없습니다. 먼저 질문에 답변해주세요.</p>
                    </div>
                `;
                modal.style.display = 'block';
                return;
            }
            const currentResult = results[idx];
            // currentResult가 유효한지 확인
            if (!currentResult || !currentResult.question || !currentResult.answer) {
                content.innerHTML = `
                    <div class="review-section">
                        <h3>데이터 오류</h3>
                        <p>결과 데이터에 문제가 있습니다. 페이지를 새로고침하고 다시 시도해주세요.</p>
                    </div>
                `;
                modal.style.display = 'block';
                return;
            }
            // 상세 분석 결과가 없는 경우 예외 처리
            if (!currentResult.detailed_analysis) {
                content.innerHTML = `
                    <div class="review-section">
                        <h3>T/F 분석</h3>
                        <p><strong>질문:</strong> ${currentResult.question}</p>
                        <p><strong>답변:</strong> ${currentResult.answer}</p>
                        <p><strong>분석 결과:</strong> <span style="color: #dc3545;">상세 분석 결과가 없습니다.</span></p>
                    </div>
                `;
                modal.style.display = 'block';
                return;
            }
            // 상세 분석 결과 표시
            content.innerHTML = `
                <div class="review-section">
                    <h3>T/F 분석</h3>
                    <p><strong>질문:</strong> ${currentResult.question}</p>
                    <p><strong>답변:</strong> ${currentResult.answer}</p>
                    <div style="margin-top: 1rem;">
                        <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">💬 F 성향 상대를 위한 답변 제안</h4>
                        <div style="background: #e8f5e8; padding: 1rem; border-radius: 8px; border-left: 4px solid #28a745; line-height: 1.6;">
                            ${(() => {
                                const alt = (currentResult.alternative_response || '').replace(/\n/g, '<br>');
                                const firstLine = alt.split('<br>')[0];
                                const rest = alt.split('<br>').slice(1).join('<br>');
                                return `<div style='font-weight:bold; color:#ff0000; margin-bottom:0.5em;'>${firstLine}</div>` + (rest ? `<div>${rest}</div>` : '');
                            })()}
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">📋 상세 분석</h4>
                        <p style="line-height: 1.6; background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            ${currentResult.detailed_analysis}
                        </p>
                    </div>
                    <div style="margin-top: 1rem;">
                        <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">🔍 분석 근거</h4>
                        <p style="line-height: 1.6; background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            ${currentResult.reasoning}
                        </p>
                    </div>
                    <div style="margin-top: 1rem;">
                        <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">💡 개선 제안</h4>
                        <ul style="background: #d1ecf1; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            ${(currentResult.suggestions || []).map(suggestion => `<li style="margin-bottom: 0.5rem;">${suggestion}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            modal.style.display = 'block';
        }

        // 리뷰 닫기
        function closeReview() {
            document.getElementById('reviewModal').style.display = 'none';
        }

        // 최종 결과 표시
        async function showFinalResult() {
            document.getElementById('questionPage').style.display = 'none';
            document.getElementById('finalPage').style.display = 'block';

            const averageScore = results.reduce((sum, r) => sum + r.score, 0) / results.length;
            const tPercentage = Math.round((100 - averageScore) / 10) * 10;
            const fPercentage = Math.round(averageScore / 10) * 10;
            
            // 기본 정보 표시
            document.getElementById('finalOneLiner').innerHTML = `
                <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; color: white; margin-bottom: 2rem;">
                    <h2 style="margin: 0; font-size: 1.8em; margin-bottom: 1rem;">🎯 최종 분석 결과</h2>
                    <p style="font-size: 2.2em; font-weight: 900; margin-bottom: 0.5rem; color: #FFE066; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); animation: pulse 2s infinite; line-height: 1.2;">${getFinalOneLiner(averageScore)}</p>
                    <p style="font-size: 1.2em; opacity: 0.9;">전체 평균: ${averageScore.toFixed(1)}점</p>
                </div>
                
                <style>
                @keyframes pulse {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.02); }
                    100% { transform: scale(1); }
                }
                </style>
            `;
            
                        // 새로운 레이아웃: 왼쪽 원형 그래프, 오른쪽 세로형 T/F 지표
            document.getElementById('finalGraph').innerHTML = `
                <div style="display: flex; align-items: center; gap: 3rem; margin: 3rem 0; justify-content: center;">
                    <!-- 왼쪽: 원형 그래프 -->
                    <div style="position: relative; width: 220px; height: 220px; flex-shrink: 0;">
                        <svg width="220" height="220" style="transform: rotate(-90deg);">
                            <circle cx="110" cy="110" r="85" fill="none" stroke="#f0f0f0" stroke-width="22"/>
                            <circle cx="110" cy="110" r="85" fill="none" stroke="#ff6b6b" stroke-width="22" 
                                    stroke-dasharray="${(100-averageScore) * 5.34} 534" stroke-linecap="round"/>
                            <circle cx="110" cy="110" r="85" fill="none" stroke="#4ecdc4" stroke-width="22" 
                                    stroke-dasharray="${averageScore * 5.34} 534" 
                                    stroke-dashoffset="${-(100-averageScore) * 5.34}" stroke-linecap="round"/>
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 2.2em; font-weight: bold; color: #333; margin-bottom: 0.2rem;">${averageScore.toFixed(1)}</div>
                            <div style="font-size: 1em; color: #666;">점</div>
                        </div>
                    </div>
                    
                    <!-- 오른쪽: 세로형 T/F 지표 -->
                    <div style="display: flex; flex-direction: column; gap: 1.5rem; min-width: 200px;">
                        <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #ff6b6b, #ff8e53); border-radius: 20px; color: white; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);">
                            <div style="font-size: 2em; font-weight: bold; margin-bottom: 0.5rem;">${tPercentage}%</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-bottom: 0.3rem;">Thinking</div>
                            <div style="font-size: 1em; opacity: 0.9;">🧠 논리적 사고</div>
                        </div>
                        
                        <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #4ecdc4, #44a08d); border-radius: 20px; color: white; box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);">
                            <div style="font-size: 2em; font-weight: bold; margin-bottom: 0.5rem;">${fPercentage}%</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-bottom: 0.3rem;">Feeling</div>
                            <div style="font-size: 1em; opacity: 0.9;">💝 감정적 공감</div>
                        </div>
                    </div>
                </div>
            `;
            
            // 로딩 상태 표시
            document.getElementById('finalReview').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <div style="font-size: 1.2em; margin-bottom: 1rem;">🤖 AI가 종합 분석 중입니다...</div>
                    <div style="width: 50px; height: 50px; border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                </div>
            `;
            
            try {
                // AI 종합 분석 요청
                const response = await fetch(`${API_BASE_URL}/final_analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        results: results
                    })
                });

                const finalAnalysis = await response.json();
                
                // AI 종합 분석 결과 표시
                document.getElementById('finalReview').innerHTML = `
                    <div style="margin-top: 2rem;">
                    <!--
                        <div style="background: #f8f9fa; padding: 2rem; border-radius: 15px; margin-bottom: 2rem; border-left: 5px solid #007bff;">
                            <h3 style="color: #2c3e50; margin-top: 0; margin-bottom: 1rem; display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">📊</span>성격 분석
                            </h3>
                            <p style="line-height: 1.7; margin: 0; white-space: pre-line;">${finalAnalysis.personality_analysis}</p>
                        </div>
                        
                        <div style="background: #fff5f5; padding: 2rem; border-radius: 15px; margin-bottom: 2rem; border-left: 5px solid #e53e3e;">
                            <h3 style="color: #2c3e50; margin-top: 0; margin-bottom: 1rem; display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">📈</span>키워드 사용 분석
                            </h3>
                            <div id="keywordChart" style="margin-top: 1rem;"></div>
                        </div>
                    -->
                        <div style="background: #e8f5e8; padding: 2rem; border-radius: 15px; margin-bottom: 2rem; border-left: 5px solid #28a745;">
                            <h3 style="color: #2c3e50; margin-top: 0; margin-bottom: 1rem; display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">💬</span>F 성향 상대 소통 전략
                            </h3>
                            <div style="line-height: 1.6; white-space: pre-line;">${finalAnalysis.communication_strategy}</div>
                        </div>
                        
                        <div style="display: flex; gap: 2rem; margin-bottom: 2rem;">
                            <div style="flex: 1; background: #fff3cd; padding: 1.5rem; border-radius: 15px; border-left: 5px solid #ffc107;">
                                <h4 style="color: #2c3e50; margin-top: 0; margin-bottom: 1rem; display: flex; align-items: center;">
                                    <span style="margin-right: 0.5rem;">⭐</span>당신의 강점
                                </h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                    ${finalAnalysis.strengths.map(strength => `<span style="display:inline-block; background: linear-gradient(90deg, #ffe066, #ffd700); color: #333; font-weight: bold; border-radius: 20px; padding: 0.4em 1em; font-size: 1em; box-shadow: 0 2px 8px rgba(255,224,102,0.15); margin-bottom: 0.2em;">#${strength.replace(/\s+/g, '')}</span>`).join('')}
                                </div>
                            </div>
                            
                            <div style="flex: 1; background: #d1ecf1; padding: 1.5rem; border-radius: 15px; border-left: 5px solid #17a2b8;">
                                <h4 style="color: #2c3e50; margin-top: 0; margin-bottom: 1rem; display: flex; align-items: center;">
                                    <span style="margin-right: 0.5rem;">🌱</span>성장 포인트
                                </h4>
                                <ul style="margin: 0; padding-left: 1.2rem;">
                                    ${finalAnalysis.growth_areas.map(area => `<li style="margin-bottom: 0.5rem; line-height: 1.5;">${area}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                
                // 키워드 분석 막대 그래프 생성
                createKeywordChart(finalAnalysis.keyword_analysis);
                
            } catch (error) {
                console.error('Error fetching final analysis:', error);
                document.getElementById('finalReview').innerHTML = `
                    <div style="background: #f8d7da; padding: 2rem; border-radius: 15px; border-left: 5px solid #dc3545; color: #721c24;">
                        <h3 style="margin-top: 0;">⚠️ 분석 오류</h3>
                        <p>종합 분석 중 오류가 발생했습니다. 기본 분석 결과를 표시합니다.</p>
                        <div style="margin-top: 1rem;">${getFinalReview(averageScore)}</div>
                    </div>
                `;
            }
        }

        // 리뷰 텍스트 생성
        function getReviewText(score) {
            if (score < 20) return "매우 논리적이고 객관적인 답변이었습니다. 감정보다는 사실에 기반한 판단을 선호하시는군요.";
            if (score < 40) return "논리적인 성향이 보이지만, 약간의 감정적 고려도 있었습니다.";
            if (score < 60) return "논리와 감정의 균형이 잘 잡힌 답변이었습니다.";
            if (score < 80) return "감정적 공감 능력이 돋보이는 답변이었습니다.";
            return "매우 감정적이고 공감적인 답변이었습니다. 다른 사람의 감정을 잘 이해하시는군요.";
        }

        // 최종 한 줄 평가 생성
        function getFinalOneLiner(score) {
            if (score < 20) return "🤖 냉철한 논리 머신! 감정? 그게 뭔가요?";
            if (score <= 40) return "📊 팩트 폭격기! 데이터가 곧 진리죠?";
            if (score >= 41 && score <= 59) return "⚖️ 논리와 감정의 줄타기 달인! 양다리 고수네요~";
            if (score < 80) return "💝 감정 공감 레이더! 눈물 한 방울도 놓치지 않죠?";
            return "😭 완전 감성팩토리! 드라마 보다가 티슈 몇 박스 써요?";
        }

        // 최종 리뷰 생성
        function getFinalReview(score) {
            let review = "";
            if (score < 20) {
                review = `
                    <p>당신은 매우 논리적이고 객관적인 판단을 선호합니다.</p>
                    <p>감정보다는 사실과 논리에 기반하여 결정을 내리는 경향이 강합니다.</p>
                    <p>문제 해결 능력이 뛰어나며, 효율적인 의사결정을 잘 하실 것 같네요.</p>
                `;
            } else if (score < 40) {
                review = `
                    <p>논리적 사고를 바탕으로 하되, 감정적 요소도 고려하시는 편입니다.</p>
                    <p>객관적 판단을 중시하지만, 상황에 따라 유연한 대처도 가능하십니다.</p>
                    <p>균형 잡힌 사고방식을 가지고 있으나, T 성향이 조금 더 강합니다.</p>
                `;
            } else if (score < 60) {
                review = `
                    <p>논리와 감정 사이에서 훌륭한 균형을 이루고 계십니다.</p>
                    <p>상황에 따라 객관적 판단과 감정적 공감을 적절히 사용하시는 것 같네요.</p>
                    <p>다양한 관점에서 문제를 바라볼 수 있는 능력이 있습니다.</p>
                `;
            } else if (score < 80) {
                review = `
                    <p>감정적 공감 능력이 뛰어나며, 다른 사람의 감정을 잘 이해하십니다.</p>
                    <p>논리적 판단도 가능하지만, 감정적 요소를 더 중요하게 고려하시는 편입니다.</p>
                    <p>인간관계에서 뛰어난 능력을 발휘하실 것 같네요.</p>
                `;
            } else {
                review = `
                    <p>매우 뛰어난 감정적 공감 능력을 가지고 계십니다.</p>
                    <p>다른 사람의 감정을 깊이 이해하고 배려하는 성향이 매우 강합니다.</p>
                    <p>인간관계에서 탁월한 능력을 보여주실 것 같네요.</p>
                `;
            }
            return review;
        }

        // 키워드 분석 막대 그래프 생성 - 개선된 버전
        function createKeywordChart(keywordData) {
            const chartContainer = document.getElementById('keywordChart');
            
            // 안전한 데이터 체크
            if (!chartContainer) {
                console.error('keywordChart 컨테이너를 찾을 수 없습니다.');
                return;
            }
            
            if (!keywordData || typeof keywordData !== 'object') {
                console.warn('키워드 데이터가 올바르지 않습니다:', keywordData);
                keywordData = {};
            }
            
            // 카테고리 정의
            const categories = {
                'logical_thinking': {
                    title: '🧠 논리적 사고',
                    description: 'Logical Thinking',
                    color: 'linear-gradient(90deg, #ff6b6b, #ff8e53)',
                    data: keywordData.logical_thinking || {}
                },
                'analytical_approach': {
                    title: '📊 분석적 접근',
                    description: 'Analytical Approach', 
                    color: 'linear-gradient(90deg, #ffa726, #ffcc02)',
                    data: keywordData.analytical_approach || {}
                },
                'emotional_empathy': {
                    title: '💝 감정적 공감',
                    description: 'Emotional Empathy',
                    color: 'linear-gradient(90deg, #4ecdc4, #44a08d)',
                    data: keywordData.emotional_empathy || {}
                },
                'relationship_focus': {
                    title: '🤝 관계 중심',
                    description: 'Relationship Focus',
                    color: 'linear-gradient(90deg, #a78bfa, #c084fc)',
                    data: keywordData.relationship_focus || {}
                }
            };
            
            // 모든 카테고리의 키워드 개수 수집
            let allCounts = [];
            Object.values(categories).forEach(category => {
                const counts = Object.values(category.data);
                allCounts = allCounts.concat(counts);
            });
            
            const maxCount = Math.max(...allCounts, 1);
            const hasData = allCounts.length > 0 && Math.max(...allCounts) > 0;
            
            let chartHTML = '<div class="keyword-chart">';
            
            if (hasData) {
                // 각 카테고리별로 차트 생성
                Object.entries(categories).forEach(([key, category]) => {
                    const usedKeywords = Object.entries(category.data).filter(([keyword, count]) => count > 0);
                    
                    if (usedKeywords.length > 0) {
                        // 카테고리별 총 사용량 계산
                        const totalCount = usedKeywords.reduce((sum, [keyword, count]) => sum + count, 0);
                        
                        chartHTML += `
                            <div class="keyword-category">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                                    <h4 style="margin: 0; color: #2c3e50;">${category.title}</h4>
                                    <span style="font-size: 0.9em; color: #666; font-weight: normal;">총 ${totalCount}회</span>
                                </div>
                                <div style="margin-bottom: 0.5rem; font-size: 0.85em; color: #777;">${category.description}</div>
                                ${usedKeywords
                                    .sort(([,a], [,b]) => b - a) // 사용 횟수 기준 내림차순 정렬
                                    .map(([keyword, count]) => `
                                    <div class="keyword-bar-container">
                                        <div class="keyword-label">${keyword}</div>
                                        <div class="keyword-bar-bg">
                                            <div class="keyword-bar" style="width: ${(count / maxCount) * 100}%; background: ${category.color};">
                                                <div class="keyword-count">${count}</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                });
                
                // 통계 요약 - 안전한 방법
                const safeSum = (obj) => {
                    try {
                        return Object.values(obj || {}).reduce((a, b) => a + b, 0) || 0;
                    } catch (e) {
                        return 0;
                    }
                };
                
                const logicalCount = safeSum(categories.logical_thinking.data) + safeSum(categories.analytical_approach.data);
                const emotionalCount = safeSum(categories.emotional_empathy.data) + safeSum(categories.relationship_focus.data);
                
                chartHTML += `
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #007bff;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #2c3e50;">📈 키워드 사용 패턴</h4>
                        <div style="display: flex; justify-content: space-around; text-align: center;">
                            <div>
                                <div style="font-size: 1.2em; font-weight: bold; color: #ff6b6b;">${logicalCount}</div>
                                <div style="font-size: 0.9em; color: #666;">논리/분석형</div>
                            </div>
                            <div style="font-size: 1.5em; color: #ddd;">vs</div>
                            <div>
                                <div style="font-size: 1.2em; font-weight: bold; color: #4ecdc4;">${emotionalCount}</div>
                                <div style="font-size: 0.9em; color: #666;">감정/관계형</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                chartHTML += `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <div style="font-size: 2em; margin-bottom: 1rem;">📝</div>
                        <p style="font-size: 1.1em; margin-bottom: 0.5rem;">분석할 키워드가 충분하지 않습니다</p>
                        <p style="font-size: 0.9em; color: #999;">더 구체적이고 상세한 답변을 작성해보세요!</p>
                    </div>
                `;
            }
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }

        // CSS 스타일 추가
        const style = document.createElement('style');
        style.textContent = `
            .review-section {
                margin-bottom: 2rem;
                padding: 1rem;
                background: #f8f9fa;
                border-radius: 8px;
            }
            
            .review-section h3 {
                margin-top: 0;
                color: #2c3e50;
            }
            
            .emotion-bars {
                margin-top: 1rem;
            }
            
            .emotion-bar {
                display: flex;
                align-items: center;
                margin-bottom: 0.5rem;
            }
            
            .emotion-label {
                width: 80px;
                font-weight: bold;
            }
            
            .emotion-bar-container {
                flex-grow: 1;
                height: 20px;
                background: #eee;
                border-radius: 10px;
                margin: 0 10px;
                overflow: hidden;
            }
            
            .emotion-bar-fill {
                height: 100%;
                background: #4CAF50;
                border-radius: 10px;
                transition: width 0.3s ease;
            }
            
            .emotion-score {
                width: 60px;
                text-align: right;
            }
            
            .communication-suggestions {
                list-style-type: none;
                padding: 0;
            }
            
            .communication-suggestions li {
                margin-bottom: 0.5rem;
                padding: 0.5rem;
                background: #fff;
                border-radius: 4px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
        `;
        document.head.appendChild(style);

        // 동적 로딩 점 애니메이션
        let loadingInterval = null;
        function startLoadingDots() {
            const dots = document.getElementById('loadingDots');
            let count = 0;
            if (loadingInterval) clearInterval(loadingInterval);
            loadingInterval = setInterval(() => {
                count = (count + 1) % 4;
                dots.textContent = '.'.repeat(count === 0 ? 3 : count);
            }, 400);
        }
        function stopLoadingDots() {
            if (loadingInterval) clearInterval(loadingInterval);
            document.getElementById('loadingDots').textContent = '';
        }
    </script>
</body>
</html> 