<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBTI T/F ë¶„ì„ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* ì¸íŠ¸ë¡œ í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
        .intro-page {
            text-align: center;
            padding: 2rem;
        }

        .main-title {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 2rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .start-button {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-button:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }

        /* íšŸìˆ˜ ì„ íƒ ë¼ë””ì˜¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .count-selection {
            display: none;
            margin-top: 2rem;
        }

        .radio-group {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .setting-group {
            margin: 1.5rem 0;
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .setting-group h3 {
            margin: 0 0 1rem 0;
            color: #333;
            font-size: 1.1rem;
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 0.8rem 0;
        }

        .setting-row label {
            font-weight: 500;
            color: #555;
            min-width: 80px;
        }

        .setting-row select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            font-size: 1rem;
            min-width: 120px;
        }

        .refresh-button {
            padding: 0.5rem 1rem;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .refresh-button:hover {
            background-color: #1976D2;
            transform: scale(1.05);
        }

        /* ì§ˆë¬¸ í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
        .question-page {
            display: none;
        }

        .character-container {
            text-align: center;
            margin-bottom: 2rem;
        }

        .character {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .face {
            width: 200px;
            height: 200px;
            position: relative;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* ëˆˆ ìŠ¤íƒ€ì¼ */
        .eyes {
            display: flex;
            justify-content: space-between;
            width: 100px;
            position: absolute;
            top: 50px;
            left: 30px;
        }

        .eye {
            width: 20px;
            height: 20px;
            background: #333;
            border-radius: 50%;
            position: relative;
        }

        /* ì… ìŠ¤íƒ€ì¼ */
        .mouth {
            width: 80px;
            height: 40px;
            position: absolute;
            bottom: 40px;
            left: 40px;
            border: 4px solid #333;
            border-radius: 0 0 40px 40px;
            border-top: 0;
            transition: all 0.3s ease;
        }

        /* í‘œì • ë³€í™” í´ë˜ìŠ¤ */
        .face-very-angry {
            background-image: url('images/Very_angry.png');
        }

        .face-angry {
            background-image: url('images/Simple_angry.png');
        }

        .face-neutral {
            background-image: url('images/Base.png');
        }

        .face-happy {
            background-image: url('images/Simple_happy.png');
        }

        .face-very-happy {
            background-image: url('images/Very_happy.png');
        }

        .speech-bubble {
            position: relative;
            background: #ffffff;
            border-radius: 1rem;
            padding: 1rem;
            margin: 1rem;
            border: 2px solid #333;
        }

        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 0;
            border: 20px solid transparent;
            border-top-color: #ffffff;
            border-bottom: 0;
            margin-left: -20px;
            margin-bottom: -20px;
        }

        .input-container {
            margin-top: 2rem;
            text-align: center;
        }

        .answer-input {
            width: 80%;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .submit-button {
            padding: 0.8rem 1.5rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-button:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }

        .next-button {
            padding: 0.8rem 1.5rem;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 1rem;
            transition: all 0.3s ease;
            display: none;
        }

        .next-button:hover {
            background-color: #1976D2;
            transform: scale(1.05);
        }

        /* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        .button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1rem;
        }

        /* ê²°ê³¼ ë¦¬ë·° ì•„ì´ì½˜ */
        .review-icon {
            display: none;
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: #2196F3;
            border-radius: 50%;
            cursor: pointer;
            color: white;
            text-align: center;
            line-height: 50px;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            margin: 50px auto;
            overflow-y: auto;
            box-sizing: border-box;
        }

        /* ëª¨ë‹¬ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* ëª¨ë‹¬ ë‚´ìš©ì´ ë§ì„ ë•Œë¥¼ ìœ„í•œ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        @media (max-height: 600px) {
            .modal-content {
                max-height: 90vh;
                margin: 20px auto;
            }
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ìµœì¢… ê²°ê³¼ í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
        .final-page {
            display: none;
            text-align: center;
        }

        .final-result {
            margin: 2rem 0;
        }

        .result-graph {
            width: 100%;
            height: 200px;
            background-color: #f0f0f0;
            margin: 1rem 0;
            border-radius: 10px;
        }

        .result-review {
            margin: 2rem 0;
            line-height: 1.6;
        }

        /* í‚¤ì›Œë“œ ì°¨íŠ¸ ìŠ¤íƒ€ì¼ */
        .keyword-chart {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .keyword-category {
            margin-bottom: 1.5rem;
        }

        .keyword-category h4 {
            margin: 0 0 0.8rem 0;
            font-size: 1.1em;
            color: #2c3e50;
        }

        .keyword-bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 0.6rem;
            padding: 0.4rem 0;
        }

        .keyword-label {
            width: 100px;
            font-size: 0.9em;
            color: #555;
            text-align: right;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .keyword-bar-bg {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .keyword-bar {
            height: 100%;
            border-radius: 10px;
            position: relative;
            transition: width 0.8s ease;
        }

        .keyword-bar.t-type {
            background: linear-gradient(90deg, #ff6b6b, #ff8e53);
        }

        .keyword-bar.f-type {
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
        }

        .keyword-count {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ì¸íŠ¸ë¡œ í˜ì´ì§€ -->
        <div class="intro-page" id="introPage">
            <h1 class="main-title">MBTI T/F ì„±í–¥ ë¶„ì„ê¸°</h1>
            <button class="start-button" id="startButton" onclick="showCountSelection()">ì‹œì‘í•˜ê¸°</button>
            <div class="count-selection" id="countSelection">
                <h2>ë¶„ì„ ì„¤ì •ì„ ì„ íƒí•˜ì„¸ìš”</h2>
                
                <!-- ë¶„ì„ íšŸìˆ˜ ì„ íƒ -->
                <div class="setting-group">
                    <h3>ë¶„ì„ íšŸìˆ˜</h3>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="count" value="1" checked> 1íšŒ
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="count" value="3"> 3íšŒ
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="count" value="5"> 5íšŒ
                        </label>
                    </div>
                </div>
                
                <!-- ì§ˆë¬¸ ì†ŒìŠ¤ ì„ íƒ -->
                <div class="setting-group">
                    <h3>ì§ˆë¬¸ íƒ€ì…</h3>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="questionSource" value="default" checked> ì¸í„°ë„· ë°ˆ(jsoní•˜ë“œì½”ë”©)
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="questionSource" value="ai"> AI ë§ì¶¤í˜•(Gemini ì—°ë™) 
                        </label>
                    </div>
                </div>
                
                <!-- AI ì§ˆë¬¸ ì„¤ì • (AI ì„ íƒ ì‹œì—ë§Œ í‘œì‹œ) -->
                <div class="setting-group" id="aiSettings" style="display: none;">
                    <h3>AI ì§ˆë¬¸ ì„¤ì •</h3>
                    <div class="setting-row">
                        <label>ë‚œì´ë„:</label>
                        <select name="difficulty" id="difficultySelect">
                            <option value="easy">ì‰¬ì›€</option>
                            <option value="medium" selected>ë³´í†µ</option>
                            <option value="hard">ì–´ë ¤ì›€</option>
                        </select>
                    </div>
                    <div class="setting-row">
                        <label>ì§ˆë¬¸ ê°œìˆ˜:</label>
                        <select name="questionCount" id="questionCountSelect">
                            <option value="3">3ê°œ</option>
                            <option value="5" selected>5ê°œ</option>
                            <option value="7">7ê°œ</option>
                            <option value="10">10ê°œ</option>
                        </select>
                    </div>
                    <button class="refresh-button" onclick="generateNewQuestions()" style="margin-top: 0.5rem;">
                        ğŸ”„ ìƒˆ ì§ˆë¬¸ ìƒì„±
                    </button>
                </div>
                
                <button class="start-button" onclick="startAnalysis()" style="margin-top: 1rem;">ë¶„ì„ ì‹œì‘</button>
            </div>
        </div>

        <!-- ì§ˆë¬¸ í˜ì´ì§€ -->
        <div class="question-page" id="questionPage">
            <div class="character-container">
                <div class="character">
                    <div class="face face-neutral" id="characterFace"></div>
                </div>
                <div class="speech-bubble">
                    <div id="question">ì§ˆë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                    <div id="resultGraph" style="display: none;"></div>
                </div>
            </div>
            <div class="input-container">
                <input type="text" class="answer-input" id="answerInput" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”...">
                <div class="button-container">
                    <button class="submit-button" id="submitButton" onclick="submitAnswer()">ë‹µë³€ ì œì¶œ</button>
                    <button class="next-button" id="nextButton" onclick="nextQuestion()">ë‹¤ìŒ ì§ˆë¬¸</button>
                </div>
                <div id="loadingMessage" style="display:none; color:#2196F3; font-weight:bold; margin-top:1rem;">
                    <span id="loadingText">AIê°€ ë¶„ì„ì¤‘ì…ë‹ˆë‹¤</span><span id="loadingDots"></span>
                </div>
            </div>
            <div class="review-icon" id="reviewIcon" onclick="showReview()">ğŸ“‹</div>
        </div>

        <!-- ìµœì¢… ê²°ê³¼ í˜ì´ì§€ -->
        <div class="final-page" id="finalPage">
            <h1>ìµœì¢… ë¶„ì„ ê²°ê³¼</h1>
            <div id="finalOneLiner"></div>
            <div id="finalGraph"></div>
            <div id="finalReview"></div>
            <button onclick="location.reload()" class="start-button">ë‹¤ì‹œ ë¶„ì„í•˜ê¸°</button>
        </div>

        <!-- ë¦¬ë·° ëª¨ë‹¬ -->
        <div class="modal" id="reviewModal" onclick="closeReview()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <h2>ë‹µë³€ ë¦¬ë·°</h2>
                <div id="reviewContent"></div>
                <button onclick="closeReview()" class="start-button" style="margin-top: 1rem;">ë‹«ê¸°</button>
            </div>
        </div>

        <!-- ìµœì¢… ê²°ê³¼ í˜ì´ì§€ -->
        <div class="final-page" id="finalPage">
            <h2>ìµœì¢… ë¶„ì„ ê²°ê³¼</h2>
            <div class="final-result">
                <p id="finalOneLiner"></p>
                <div class="result-graph" id="finalGraph"></div>
                <div id="finalCharacter"></div>
                <div class="result-review" id="finalReview"></div>
            </div>
        </div>
    </div>

    <script>
        // API ê¸°ë³¸ URL ì„¤ì •
        const API_BASE_URL = 'http://localhost:8000';
        
        // ì „ì—­ ë³€ìˆ˜
        let currentCount = 0;
        let maxCount = 0;
        let results = [];
        let usedQuestions = new Set(); // ì‚¬ìš©ëœ ì§ˆë¬¸ë“¤ì„ ì¶”ì 
        let currentQuestionIndex = 0;
        let questions = [];
        let answers = [];
        let totalQuestions = 0;

        // ì§ˆë¬¸ ë°ì´í„° ë¡œë“œ
        async function loadQuestions() {
            try {
                const response = await fetch(`${API_BASE_URL}/questions`);
                console.log('ì„œë²„ ì‘ë‹µ:', response);
                const data = await response.json();
                console.log('ë°›ì€ ë°ì´í„°:', data);
                questions = data.questions;
                totalQuestions = questions.length;
                displayQuestion();
            } catch (error) {
                console.error('ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
                document.getElementById('question').textContent = 'ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
            }
        }

        // ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì‹œ
        document.getElementById('startButton').addEventListener('click', function() {
            document.getElementById('startButton').style.display = 'none';
            document.getElementById('countSelection').style.display = 'block';
        });

        // ì§ˆë¬¸ í‘œì‹œ
        function displayQuestion() {
            if (currentQuestionIndex < totalQuestions) {
                document.getElementById('question').textContent = questions[currentQuestionIndex];
            }
        }

        // ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ ì´ë™
        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < totalQuestions) {
                displayQuestion();
                const answerInput = document.getElementById('answerInput');
                answerInput.value = '';
                answerInput.disabled = false;  // ì…ë ¥ í•„ë“œ í™œì„±í™”
                document.getElementById('nextButton').style.display = 'none';
                document.getElementById('submitButton').style.display = 'inline-block';
                document.getElementById('submitButton').disabled = false;  // ì œì¶œ ë²„íŠ¼ í™œì„±í™”
                document.getElementById('resultGraph').style.display = 'none';
            } else {
                // ëª¨ë“  ì§ˆë¬¸ì´ ëë‚¬ì„ ë•Œ
                finishQuestions();
            }
        }

        // ë‹µë³€ ì œì¶œ
        async function submitAnswer() {
            const answerInput = document.getElementById('answerInput');
            const answer = answerInput.value.trim();
            
            if (answer === '') {
                alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                document.getElementById('loadingMessage').style.display = 'none'; // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
                return;
            }

            // ì•„ë˜ fetch ë° ê²°ê³¼ í‘œì‹œ ì½”ë“œëŠ” ì„ì‹œë¡œ ì£¼ì„ ì²˜ë¦¬
            /*
            answerInput.disabled = true;
            document.getElementById('submitButton').disabled = true;

            setTimeout(async () => {
                try {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    const response = await fetch(`${API_BASE_URL}/analyze`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ text: answer })
                    });
                    const result = await response.json();
                    const tfScore = result.score;
                    if (result.prompt) {
                        console.log('[Gemini í”„ë¡¬í”„íŠ¸]', result.prompt);
                    }
                    // ê²°ê³¼ ê·¸ë˜í”„ í‘œì‹œ
                    const resultGraph = document.getElementById('resultGraph');
                    resultGraph.innerHTML = `
                        <div style=\"margin-top: 20px;\">
                            <div>T/F ì„±í–¥ ì ìˆ˜: ${tfScore.toFixed(1)}</div>
                            <div style=\"background: #eee; height: 20px; width: 100%; margin-top: 10px;\">
                                <div style=\"background: #4CAF50; height: 100%; width: ${tfScore}%;\"></div>
                            </div>
                            <div style=\"display: flex; justify-content: space-between; margin-top: 5px;\">
                                <span>Tí˜•</span>
                                <span>Fí˜•</span>
                            </div>
                        </div>
                    `;
                    resultGraph.style.display = 'block';
                    
                    updateCharacterExpression(tfScore);
                    
                    // ì…ë ¥ í•„ë“œì™€ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                    answerInput.disabled = true;  // í˜„ì¬ ë‹µë³€ ì…ë ¥ ë¹„í™œì„±í™”
                    document.getElementById('submitButton').style.display = 'none';
                    document.getElementById('nextButton').style.display = 'inline-block';
                    // ë¶„ì„ì¤‘ ë©”ì‹œì§€ 0.5ì´ˆ í›„ ìì—°ìŠ¤ëŸ½ê²Œ ìˆ¨ê¹€
                    setTimeout(() => {
                        document.getElementById('loadingMessage').style.display = 'none';
                        document.getElementById('submitButton').disabled = false;
                    }, 500);
                } catch (error) {
                    console.error('Error:', error);
                    alert('ë‹µë³€ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    answerInput.disabled = false;  // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì…ë ¥ í•„ë“œ ë‹¤ì‹œ í™œì„±í™”
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('submitButton').disabled = false;
                }
            }, 0);
            */
        }

        // ëª¨ë“  ì§ˆë¬¸ì´ ëë‚¬ì„ ë•Œ
        function finishQuestions() {
            const questionContainer = document.querySelector('.question-page');
            questionContainer.innerHTML = `
                <h2>ëª¨ë“  ì§ˆë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
                <div class="final-results">
                    <h3>ë‹¹ì‹ ì˜ ë‹µë³€ ê¸°ë¡:</h3>
                    ${answers.map((answer, index) => `
                        <div class="answer-record">
                            <p><strong>Q${index + 1}:</strong> ${questions[index]}</p>
                            <p><strong>A:</strong> ${answer}</p>
                        </div>
                    `).join('')}
                </div>
                <button onclick="location.reload()" class="start-button">ë‹¤ì‹œ ì‹œì‘í•˜ê¸°</button>
            `;
        }

        // ìºë¦­í„° ì´ˆê¸°í™”
        function initCharacter() {
            const character = document.getElementById('characterFace');
            if (character) {
                character.className = 'face face-neutral';
            }
        }

        // í‘œì • ë³€ê²½
        function updateCharacterExpression(score) {
            const face = document.getElementById('characterFace');
            if (face) {
            face.className = 'face'; // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°

            if (score < 20) {
                face.classList.add('face-very-angry');
            } else if (score < 40) {
                face.classList.add('face-angry');
            } else if (score < 60) {
                face.classList.add('face-neutral');
            } else if (score < 80) {
                face.classList.add('face-happy');
            } else {
                face.classList.add('face-very-happy');
                }
            }
        }

        // ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì‹œ íšŸìˆ˜ ì„ íƒ í‘œì‹œ
        function showCountSelection() {
            document.getElementById('countSelection').style.display = 'block';
        }

        // ì§ˆë¬¸ ë°ì´í„° ë¡œë“œ
        async function loadQuestions() {
            try {
                const selectedSource = document.querySelector('input[name="questionSource"]:checked');
                
                let url = `${API_BASE_URL}/questions`;
                let params = new URLSearchParams();
                
                if (selectedSource && selectedSource.value === 'ai') {
                    // AI ì§ˆë¬¸ ì„¤ì •
                    const difficulty = document.getElementById('difficultySelect').value;
                    const count = parseInt(document.getElementById('questionCountSelect').value);
                    
                    params.append('use_ai', 'true');
                    params.append('difficulty', difficulty);
                    params.append('count', count.toString());
                } else {
                    // ê¸°ë³¸ ì§ˆë¬¸ ì‚¬ìš©
                    params.append('use_ai', 'false');
                }
                
                const response = await fetch(`${url}?${params}`);
                const data = await response.json();
                questions = data.questions;
                
                console.log(`ì§ˆë¬¸ ë¡œë“œ ì™„ë£Œ: ${data.source || 'unknown'} ì†ŒìŠ¤ì—ì„œ ${questions.length}ê°œ ì§ˆë¬¸`);
                
                showNextQuestion();
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëœë¤ ì§ˆë¬¸ ì„ íƒ
        function getRandomQuestion() {
            const availableQuestions = questions.filter((_, index) => !usedQuestions.has(index));
            if (availableQuestions.length === 0) {
                usedQuestions.clear();
                return questions[Math.floor(Math.random() * questions.length)];
            }
            const randomIndex = Math.floor(Math.random() * availableQuestions.length);
            const questionIndex = questions.findIndex(q => q === availableQuestions[randomIndex]);
            usedQuestions.add(questionIndex);
            return availableQuestions[randomIndex];
        }

        // ë‹µë³€ ì œì¶œ
        async function submitAnswer() {
            const answer = document.getElementById('answerInput').value.trim();
            if (!answer) {
                alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                document.getElementById('loadingMessage').style.display = 'none'; // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
                return;
            }

            document.getElementById('loadingMessage').style.display = 'block';
            startLoadingDots(); // ë¡œë”© ì  ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘

            try {
                // API í˜¸ì¶œ
                const response = await fetch(`${API_BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: answer })
                });

                if (!response.ok) {
                    throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
                }

                const data = await response.json();
                // detailed_analysis ë“± ìƒì„¸ ë¶„ì„ ê²°ê³¼ë„ ì €ì¥
                results.push({
                    question: document.getElementById('question').textContent,
                    answer: answer,
                    score: data.score,
                    detailed_analysis: data.detailed_analysis,
                    reasoning: data.reasoning,
                    suggestions: data.suggestions,
                    alternative_response: data.alternative_response
                });

                showResult(data.score);
                // currentCount++;
            } catch (error) {
                console.error('Error:', error);
                alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                document.getElementById('loadingMessage').style.display = 'none'; // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
                stopLoadingDots(); // ë¡œë”© ì  ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
            }
        }

        // ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ ì´ë™
        function nextQuestion() {
            currentCount++;
            
            if (currentCount >= maxCount) {
                showFinalResult();
                return;
            }

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').disabled = false;
            document.getElementById('resultGraph').style.display = 'none';
            document.querySelector('.submit-button').disabled = false;
            document.querySelector('.submit-button').style.opacity = '1';
            document.getElementById('nextButton').style.display = 'none';
            
            // ë¦¬ë·° ì•„ì´ì½˜ ìˆ¨ê¸°ê¸°
            document.getElementById('reviewIcon').style.display = 'none';
            
            showNextQuestion();
        }

        // ë¶„ì„ ì‹œì‘
        function startAnalysis() {
            const selectedCount = document.querySelector('input[name="count"]:checked');
            if (!selectedCount) {
                alert('íšŸìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const selectedSource = document.querySelector('input[name="questionSource"]:checked');
            if (!selectedSource) {
                alert('ì§ˆë¬¸ íƒ€ì…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            maxCount = parseInt(selectedCount.value);
            currentCount = 0;
            results = [];
            usedQuestions.clear(); // ì‚¬ìš©ëœ ì§ˆë¬¸ ëª©ë¡ ì´ˆê¸°í™”

            document.getElementById('introPage').style.display = 'none';
            document.getElementById('questionPage').style.display = 'block';
            initCharacter();
            // showNextQuestion(); // ì´ ë¶€ë¶„ì€ ìƒˆë¡œìš´ ë¡œì§ìœ¼ë¡œ ëŒ€ì²´ë¨
            loadQuestions(); // ì§ˆë¬¸ ë°ì´í„° ë¡œë“œ
        
        // AI ì„¤ì • í‘œì‹œ/ìˆ¨ê¹€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', function() {
            const questionSourceRadios = document.querySelectorAll('input[name="questionSource"]');
            questionSourceRadios.forEach(radio => {
                radio.addEventListener('change', toggleAISettings);
            });
        });

        // AI ì„¤ì • í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
        function toggleAISettings() {
            const selectedSource = document.querySelector('input[name="questionSource"]:checked');
            const aiSettings = document.getElementById('aiSettings');
            
            if (selectedSource && selectedSource.value === 'ai') {
                aiSettings.style.display = 'block';
            } else {
                aiSettings.style.display = 'none';
            }
        }

        // ìƒˆë¡œìš´ AI ì§ˆë¬¸ ìƒì„±
        async function generateNewQuestions() {
            const difficulty = document.getElementById('difficultySelect').value;
            const count = parseInt(document.getElementById('questionCountSelect').value);
            
            try {
                const response = await fetch(`${API_BASE_URL}/generate_questions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        count: count,
                        difficulty: difficulty
                    })
                });
                
                if (!response.ok) {
                    throw new Error('AI ì§ˆë¬¸ ìƒì„± ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                questions = data.questions;
                
                alert(`ìƒˆë¡œìš´ ${difficulty} ë‚œì´ë„ì˜ ${count}ê°œ ì§ˆë¬¸ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                
            } catch (error) {
                console.error('Error generating questions:', error);
                alert('AI ì§ˆë¬¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
        }

        // ë‹¤ìŒ ì§ˆë¬¸ í‘œì‹œ
        function showNextQuestion() {
            if (currentCount >= maxCount) {
                showFinalResult();
                return;
            }

            const question = getRandomQuestion();
            document.getElementById('question').textContent = question;
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').disabled = false;
            document.getElementById('resultGraph').style.display = 'none';
            document.getElementById('reviewIcon').style.display = 'none';
            
            // ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
            document.querySelector('.submit-button').disabled = false;
            document.querySelector('.submit-button').style.opacity = '1';
            document.getElementById('nextButton').style.display = 'none';
        }

        // ë‹µë³€ ì œì¶œ
        async function submitAnswer() {
            const answer = document.getElementById('answerInput').value.trim();
            if (!answer) {
                alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                document.getElementById('loadingMessage').style.display = 'none'; // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
                return;
            }

            document.getElementById('loadingMessage').style.display = 'block';
            startLoadingDots(); // ë¡œë”© ì  ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘

            try {
                // API í˜¸ì¶œ
                const response = await fetch(`${API_BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: answer })
                });

                if (!response.ok) {
                    throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
                }

                const data = await response.json();
                // detailed_analysis ë“± ìƒì„¸ ë¶„ì„ ê²°ê³¼ë„ ì €ì¥
                results.push({
                    question: document.getElementById('question').textContent,
                    answer: answer,
                    score: data.score,
                    detailed_analysis: data.detailed_analysis,
                    reasoning: data.reasoning,
                    suggestions: data.suggestions,
                    alternative_response: data.alternative_response
                });

                showResult(data.score);
                // currentCount++;
            } catch (error) {
                console.error('Error:', error);
                alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                document.getElementById('loadingMessage').style.display = 'none'; // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
                stopLoadingDots(); // ë¡œë”© ì  ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
            }
        }

        // ê²°ê³¼ í‘œì‹œ
        function showResult(tfScore) {
            const resultGraph = document.getElementById('resultGraph');
            resultGraph.style.display = 'block';
            
            updateCharacterExpression(tfScore);
            
            // Tì™€ Fì˜ ë¹„ìœ¨ ê³„ì‚° (í•­ìƒ T = 100-tfScore, F = tfScore)
            const tPercentage = 100 - tfScore;
            const fPercentage = tfScore;
            
            // ê·¸ë˜í”„ í‘œì‹œ (í…ìŠ¤íŠ¸ì™€ ìˆ˜ì¹˜ í‘œí˜„)
            let resultText = '';
            if (tfScore < 20) resultText = `ë‹¹ì‹ ì€ í™•ì‹¤í•œ Tì…ë‹ˆë‹¤! "ë„ˆ Të°œCì•¼?" (T: ${tPercentage}% / F: ${fPercentage}%)`;
            else if (tfScore <= 40) resultText = `ë‹¹ì‹ ì€ T ì„±í–¥ì´ ê°•í•©ë‹ˆë‹¤. (T: ${tPercentage}% / F: ${fPercentage}%)`;
            else if (tfScore >= 41 && tfScore <= 59) resultText = `ë‹¹ì‹ ì€ Tì™€ Fì˜ ê· í˜•ì´ ì˜ ì¡í˜€ìˆìŠµë‹ˆë‹¤. (T: ${tPercentage}% / F: ${fPercentage}%)`;
            else if (tfScore < 80) resultText = `ë‹¹ì‹ ì€ F ì„±í–¥ì´ ê°•í•©ë‹ˆë‹¤. (T: ${tPercentage}% / F: ${fPercentage}%)`;
            else resultText = `ë‹¹ì‹ ì€ í™•ì‹¤í•œ Fì…ë‹ˆë‹¤! "ë„ˆ Fêµ¬ë‚˜?" (T: ${tPercentage}% / F: ${fPercentage}%)`;

            resultGraph.innerHTML = `
                <p style="margin: 1rem 0; font-size: 1.2em; font-weight: bold;">${resultText}</p>
                <div style="position: relative; width: 100%; margin: 2rem 0;">
                    <div style="width: 100%; height: 40px; background: linear-gradient(to right, #ff4444, #ffff44, #44ff44); border-radius: 20px; position: relative;">
                        <div style="width: 4px; height: 50px; background: black; position: absolute; left: ${tfScore}%; top: -5px;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 1.1em;">
                        <div style="text-align: left; width: 45%; background: rgba(255,68,68,0.1); padding: 10px; border-radius: 10px;">
                            <span style="font-weight: bold; color: #ff4444;">Thinking: ${tPercentage}%</span>
                        </div>
                        <div style="text-align: right; width: 45%; background: rgba(68,255,68,0.1); padding: 10px; border-radius: 10px;">
                            <span style="font-weight: bold; color: #44ff44;">Feeling: ${fPercentage}%</span>
                        </div>
                    </div>
                </div>
            `;

            // ë‹µë³€ ì œì¶œ ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë‹¤ìŒ ë²„íŠ¼ í‘œì‹œ
            document.querySelector('.submit-button').disabled = true;
            document.querySelector('.submit-button').style.opacity = '0.5';
            document.getElementById('nextButton').style.display = 'inline-block';
            document.getElementById('answerInput').disabled = true;
            
            // ë¦¬ë·° ì•„ì´ì½˜ í‘œì‹œ
            document.getElementById('reviewIcon').style.display = 'block';
            // ë¶„ì„ì¤‘ ë©”ì‹œì§€ í•­ìƒ ìˆ¨ê¹€
            document.getElementById('loadingMessage').style.display = 'none';
            stopLoadingDots(); // ë¡œë”© ì  ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
        }

        // ë¦¬ë·° í‘œì‹œ
        function showReview() {
            const modal = document.getElementById('reviewModal');
            const content = document.getElementById('reviewContent');
            // í•­ìƒ ìµœì‹  ë‹µë³€ ë¦¬ë·°ë¥¼ ì°¸ì¡°í•˜ë„ë¡ ì¸ë±ìŠ¤ ìˆ˜ì •
            const idx = results.length - 1;
            // ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
            console.log('showReview í˜¸ì¶œ - idx:', idx, 'results ê¸¸ì´:', results?.length, 'results:', results);
            // ì•ˆì „ì„± ê²€ì‚¬: ìœ íš¨í•œ ê²°ê³¼ê°€ ìˆëŠ”ì§€ í™•ì¸
            if (!results || results.length === 0 || idx < 0) {
                content.innerHTML = `
                    <div class="review-section">
                        <h3>ë¦¬ë·° ì—†ìŒ</h3>
                        <p>ì•„ì§ ë¶„ì„ëœ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
                modal.style.display = 'block';
                return;
            }
            const currentResult = results[idx];
            // currentResultê°€ ìœ íš¨í•œì§€ í™•ì¸
            if (!currentResult || !currentResult.question || !currentResult.answer) {
                content.innerHTML = `
                    <div class="review-section">
                        <h3>ë°ì´í„° ì˜¤ë¥˜</h3>
                        <p>ê²°ê³¼ ë°ì´í„°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
                modal.style.display = 'block';
                return;
            }
            // ìƒì„¸ ë¶„ì„ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš° ì˜ˆì™¸ ì²˜ë¦¬
            if (!currentResult.detailed_analysis) {
                content.innerHTML = `
                    <div class="review-section">
                        <h3>T/F ë¶„ì„</h3>
                        <p><strong>ì§ˆë¬¸:</strong> ${currentResult.question}</p>
                        <p><strong>ë‹µë³€:</strong> ${currentResult.answer}</p>
                        <p><strong>ë¶„ì„ ê²°ê³¼:</strong> <span style="color: #dc3545;">ìƒì„¸ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</span></p>
                    </div>
                `;
                modal.style.display = 'block';
                return;
            }
            // ìƒì„¸ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
            content.innerHTML = `
                <div class="review-section">
                    <h3>T/F ë¶„ì„</h3>
                    <p><strong>ì§ˆë¬¸:</strong> ${currentResult.question}</p>
                    <p><strong>ë‹µë³€:</strong> ${currentResult.answer}</p>
                    <div style="margin-top: 1rem;">
                        <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">ğŸ’¬ F ì„±í–¥ ìƒëŒ€ë¥¼ ìœ„í•œ ë‹µë³€ ì œì•ˆ</h4>
                        <div style="background: #e8f5e8; padding: 1rem; border-radius: 8px; border-left: 4px solid #28a745; line-height: 1.6;">
                            ${(() => {
                                const alt = (currentResult.alternative_response || '').replace(/\n/g, '<br>');
                                const firstLine = alt.split('<br>')[0];
                                const rest = alt.split('<br>').slice(1).join('<br>');
                                return `<div style='font-weight:bold; color:#ff0000; margin-bottom:0.5em;'>${firstLine}</div>` + (rest ? `<div>${rest}</div>` : '');
                            })()}
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">ğŸ“‹ ìƒì„¸ ë¶„ì„</h4>
                        <p style="line-height: 1.6; background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            ${currentResult.detailed_analysis}
                        </p>
                    </div>
                    <div style="margin-top: 1rem;">
                        <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">ğŸ” ë¶„ì„ ê·¼ê±°</h4>
                        <p style="line-height: 1.6; background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            ${currentResult.reasoning}
                        </p>
                    </div>
                    <div style="margin-top: 1rem;">
                        <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">ğŸ’¡ ê°œì„  ì œì•ˆ</h4>
                        <ul style="background: #d1ecf1; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            ${(currentResult.suggestions || []).map(suggestion => `<li style="margin-bottom: 0.5rem;">${suggestion}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            modal.style.display = 'block';
        }

        // ë¦¬ë·° ë‹«ê¸°
        function closeReview() {
            document.getElementById('reviewModal').style.display = 'none';
        }

        // ìµœì¢… ê²°ê³¼ í‘œì‹œ
        async function showFinalResult() {
            document.getElementById('questionPage').style.display = 'none';
            document.getElementById('finalPage').style.display = 'block';

            const averageScore = results.reduce((sum, r) => sum + r.score, 0) / results.length;
            const tPercentage = Math.round((100 - averageScore) / 10) * 10;
            const fPercentage = Math.round(averageScore / 10) * 10;
            
            // ê¸°ë³¸ ì •ë³´ í‘œì‹œ
            document.getElementById('finalOneLiner').innerHTML = `
                <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; color: white; margin-bottom: 2rem;">
                    <h2 style="margin: 0; font-size: 1.8em; margin-bottom: 1rem;">ğŸ¯ ìµœì¢… ë¶„ì„ ê²°ê³¼</h2>
                    <p style="font-size: 2.2em; font-weight: 900; margin-bottom: 0.5rem; color: #FFE066; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); animation: pulse 2s infinite; line-height: 1.2;">${getFinalOneLiner(averageScore)}</p>
                    <p style="font-size: 1.2em; opacity: 0.9;">ì „ì²´ í‰ê· : ${averageScore.toFixed(1)}ì </p>
                </div>
                
                <style>
                @keyframes pulse {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.02); }
                    100% { transform: scale(1); }
                }
                </style>
            `;
            
                        // ìƒˆë¡œìš´ ë ˆì´ì•„ì›ƒ: ì™¼ìª½ ì›í˜• ê·¸ë˜í”„, ì˜¤ë¥¸ìª½ ì„¸ë¡œí˜• T/F ì§€í‘œ
            document.getElementById('finalGraph').innerHTML = `
                <div style="display: flex; align-items: center; gap: 3rem; margin: 3rem 0; justify-content: center;">
                    <!-- ì™¼ìª½: ì›í˜• ê·¸ë˜í”„ -->
                    <div style="position: relative; width: 220px; height: 220px; flex-shrink: 0;">
                        <svg width="220" height="220" style="transform: rotate(-90deg);">
                            <circle cx="110" cy="110" r="85" fill="none" stroke="#f0f0f0" stroke-width="22"/>
                            <circle cx="110" cy="110" r="85" fill="none" stroke="#ff6b6b" stroke-width="22" 
                                    stroke-dasharray="${(100-averageScore) * 5.34} 534" stroke-linecap="round"/>
                            <circle cx="110" cy="110" r="85" fill="none" stroke="#4ecdc4" stroke-width="22" 
                                    stroke-dasharray="${averageScore * 5.34} 534" 
                                    stroke-dashoffset="${-(100-averageScore) * 5.34}" stroke-linecap="round"/>
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 2.2em; font-weight: bold; color: #333; margin-bottom: 0.2rem;">${averageScore.toFixed(1)}</div>
                            <div style="font-size: 1em; color: #666;">ì </div>
                        </div>
                    </div>
                    
                    <!-- ì˜¤ë¥¸ìª½: ì„¸ë¡œí˜• T/F ì§€í‘œ -->
                    <div style="display: flex; flex-direction: column; gap: 1.5rem; min-width: 200px;">
                        <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #ff6b6b, #ff8e53); border-radius: 20px; color: white; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);">
                            <div style="font-size: 2em; font-weight: bold; margin-bottom: 0.5rem;">${tPercentage}%</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-bottom: 0.3rem;">Thinking</div>
                            <div style="font-size: 1em; opacity: 0.9;">ğŸ§  ë…¼ë¦¬ì  ì‚¬ê³ </div>
                        </div>
                        
                        <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #4ecdc4, #44a08d); border-radius: 20px; color: white; box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);">
                            <div style="font-size: 2em; font-weight: bold; margin-bottom: 0.5rem;">${fPercentage}%</div>
                            <div style="font-size: 1.3em; font-weight: 600; margin-bottom: 0.3rem;">Feeling</div>
                            <div style="font-size: 1em; opacity: 0.9;">ğŸ’ ê°ì •ì  ê³µê°</div>
                        </div>
                    </div>
                </div>
            `;
            
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            document.getElementById('finalReview').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <div style="font-size: 1.2em; margin-bottom: 1rem;">ğŸ¤– AIê°€ ì¢…í•© ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>
                    <div style="width: 50px; height: 50px; border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                </div>
            `;
            
            try {
                // AI ì¢…í•© ë¶„ì„ ìš”ì²­
                const response = await fetch(`${API_BASE_URL}/final_analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        results: results
                    })
                });

                const finalAnalysis = await response.json();
                
                // AI ì¢…í•© ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                document.getElementById('finalReview').innerHTML = `
                    <div style="margin-top: 2rem;">
                    <!--
                        <div style="background: #f8f9fa; padding: 2rem; border-radius: 15px; margin-bottom: 2rem; border-left: 5px solid #007bff;">
                            <h3 style="color: #2c3e50; margin-top: 0; margin-bottom: 1rem; display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">ğŸ“Š</span>ì„±ê²© ë¶„ì„
                            </h3>
                            <p style="line-height: 1.7; margin: 0; white-space: pre-line;">${finalAnalysis.personality_analysis}</p>
                        </div>
                        
                        <div style="background: #fff5f5; padding: 2rem; border-radius: 15px; margin-bottom: 2rem; border-left: 5px solid #e53e3e;">
                            <h3 style="color: #2c3e50; margin-top: 0; margin-bottom: 1rem; display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">ğŸ“ˆ</span>í‚¤ì›Œë“œ ì‚¬ìš© ë¶„ì„
                            </h3>
                            <div id="keywordChart" style="margin-top: 1rem;"></div>
                        </div>
                    -->
                        <div style="background: #e8f5e8; padding: 2rem; border-radius: 15px; margin-bottom: 2rem; border-left: 5px solid #28a745;">
                            <h3 style="color: #2c3e50; margin-top: 0; margin-bottom: 1rem; display: flex; align-items: center;">
                                <span style="margin-right: 0.5rem;">ğŸ’¬</span>F ì„±í–¥ ìƒëŒ€ ì†Œí†µ ì „ëµ
                            </h3>
                            <div style="line-height: 1.6; white-space: pre-line;">${finalAnalysis.communication_strategy}</div>
                        </div>
                        
                        <div style="display: flex; gap: 2rem; margin-bottom: 2rem;">
                            <div style="flex: 1; background: #fff3cd; padding: 1.5rem; border-radius: 15px; border-left: 5px solid #ffc107;">
                                <h4 style="color: #2c3e50; margin-top: 0; margin-bottom: 1rem; display: flex; align-items: center;">
                                    <span style="margin-right: 0.5rem;">â­</span>ë‹¹ì‹ ì˜ ê°•ì 
                                </h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                    ${finalAnalysis.strengths.map(strength => `<span style="display:inline-block; background: linear-gradient(90deg, #ffe066, #ffd700); color: #333; font-weight: bold; border-radius: 20px; padding: 0.4em 1em; font-size: 1em; box-shadow: 0 2px 8px rgba(255,224,102,0.15); margin-bottom: 0.2em;">#${strength.replace(/\s+/g, '')}</span>`).join('')}
                                </div>
                            </div>
                            
                            <div style="flex: 1; background: #d1ecf1; padding: 1.5rem; border-radius: 15px; border-left: 5px solid #17a2b8;">
                                <h4 style="color: #2c3e50; margin-top: 0; margin-bottom: 1rem; display: flex; align-items: center;">
                                    <span style="margin-right: 0.5rem;">ğŸŒ±</span>ì„±ì¥ í¬ì¸íŠ¸
                                </h4>
                                <ul style="margin: 0; padding-left: 1.2rem;">
                                    ${finalAnalysis.growth_areas.map(area => `<li style="margin-bottom: 0.5rem; line-height: 1.5;">${area}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                
                // í‚¤ì›Œë“œ ë¶„ì„ ë§‰ëŒ€ ê·¸ë˜í”„ ìƒì„±
                createKeywordChart(finalAnalysis.keyword_analysis);
                
            } catch (error) {
                console.error('Error fetching final analysis:', error);
                document.getElementById('finalReview').innerHTML = `
                    <div style="background: #f8d7da; padding: 2rem; border-radius: 15px; border-left: 5px solid #dc3545; color: #721c24;">
                        <h3 style="margin-top: 0;">âš ï¸ ë¶„ì„ ì˜¤ë¥˜</h3>
                        <p>ì¢…í•© ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ë¶„ì„ ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</p>
                        <div style="margin-top: 1rem;">${getFinalReview(averageScore)}</div>
                    </div>
                `;
            }
        }

        // ë¦¬ë·° í…ìŠ¤íŠ¸ ìƒì„±
        function getReviewText(score) {
            if (score < 20) return "ë§¤ìš° ë…¼ë¦¬ì ì´ê³  ê°ê´€ì ì¸ ë‹µë³€ì´ì—ˆìŠµë‹ˆë‹¤. ê°ì •ë³´ë‹¤ëŠ” ì‚¬ì‹¤ì— ê¸°ë°˜í•œ íŒë‹¨ì„ ì„ í˜¸í•˜ì‹œëŠ”êµ°ìš”.";
            if (score < 40) return "ë…¼ë¦¬ì ì¸ ì„±í–¥ì´ ë³´ì´ì§€ë§Œ, ì•½ê°„ì˜ ê°ì •ì  ê³ ë ¤ë„ ìˆì—ˆìŠµë‹ˆë‹¤.";
            if (score < 60) return "ë…¼ë¦¬ì™€ ê°ì •ì˜ ê· í˜•ì´ ì˜ ì¡íŒ ë‹µë³€ì´ì—ˆìŠµë‹ˆë‹¤.";
            if (score < 80) return "ê°ì •ì  ê³µê° ëŠ¥ë ¥ì´ ë‹ë³´ì´ëŠ” ë‹µë³€ì´ì—ˆìŠµë‹ˆë‹¤.";
            return "ë§¤ìš° ê°ì •ì ì´ê³  ê³µê°ì ì¸ ë‹µë³€ì´ì—ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì‚¬ëŒì˜ ê°ì •ì„ ì˜ ì´í•´í•˜ì‹œëŠ”êµ°ìš”.";
        }

        // ìµœì¢… í•œ ì¤„ í‰ê°€ ìƒì„±
        function getFinalOneLiner(score) {
            if (score < 20) return "ğŸ¤– ëƒ‰ì² í•œ ë…¼ë¦¬ ë¨¸ì‹ ! ê°ì •? ê·¸ê²Œ ë­”ê°€ìš”?";
            if (score <= 40) return "ğŸ“Š íŒ©íŠ¸ í­ê²©ê¸°! ë°ì´í„°ê°€ ê³§ ì§„ë¦¬ì£ ?";
            if (score >= 41 && score <= 59) return "âš–ï¸ ë…¼ë¦¬ì™€ ê°ì •ì˜ ì¤„íƒ€ê¸° ë‹¬ì¸! ì–‘ë‹¤ë¦¬ ê³ ìˆ˜ë„¤ìš”~";
            if (score < 80) return "ğŸ’ ê°ì • ê³µê° ë ˆì´ë”! ëˆˆë¬¼ í•œ ë°©ìš¸ë„ ë†“ì¹˜ì§€ ì•Šì£ ?";
            return "ğŸ˜­ ì™„ì „ ê°ì„±íŒ©í† ë¦¬! ë“œë¼ë§ˆ ë³´ë‹¤ê°€ í‹°ìŠˆ ëª‡ ë°•ìŠ¤ ì¨ìš”?";
        }

        // ìµœì¢… ë¦¬ë·° ìƒì„±
        function getFinalReview(score) {
            let review = "";
            if (score < 20) {
                review = `
                    <p>ë‹¹ì‹ ì€ ë§¤ìš° ë…¼ë¦¬ì ì´ê³  ê°ê´€ì ì¸ íŒë‹¨ì„ ì„ í˜¸í•©ë‹ˆë‹¤.</p>
                    <p>ê°ì •ë³´ë‹¤ëŠ” ì‚¬ì‹¤ê³¼ ë…¼ë¦¬ì— ê¸°ë°˜í•˜ì—¬ ê²°ì •ì„ ë‚´ë¦¬ëŠ” ê²½í–¥ì´ ê°•í•©ë‹ˆë‹¤.</p>
                    <p>ë¬¸ì œ í•´ê²° ëŠ¥ë ¥ì´ ë›°ì–´ë‚˜ë©°, íš¨ìœ¨ì ì¸ ì˜ì‚¬ê²°ì •ì„ ì˜ í•˜ì‹¤ ê²ƒ ê°™ë„¤ìš”.</p>
                `;
            } else if (score < 40) {
                review = `
                    <p>ë…¼ë¦¬ì  ì‚¬ê³ ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•˜ë˜, ê°ì •ì  ìš”ì†Œë„ ê³ ë ¤í•˜ì‹œëŠ” í¸ì…ë‹ˆë‹¤.</p>
                    <p>ê°ê´€ì  íŒë‹¨ì„ ì¤‘ì‹œí•˜ì§€ë§Œ, ìƒí™©ì— ë”°ë¼ ìœ ì—°í•œ ëŒ€ì²˜ë„ ê°€ëŠ¥í•˜ì‹­ë‹ˆë‹¤.</p>
                    <p>ê· í˜• ì¡íŒ ì‚¬ê³ ë°©ì‹ì„ ê°€ì§€ê³  ìˆìœ¼ë‚˜, T ì„±í–¥ì´ ì¡°ê¸ˆ ë” ê°•í•©ë‹ˆë‹¤.</p>
                `;
            } else if (score < 60) {
                review = `
                    <p>ë…¼ë¦¬ì™€ ê°ì • ì‚¬ì´ì—ì„œ í›Œë¥­í•œ ê· í˜•ì„ ì´ë£¨ê³  ê³„ì‹­ë‹ˆë‹¤.</p>
                    <p>ìƒí™©ì— ë”°ë¼ ê°ê´€ì  íŒë‹¨ê³¼ ê°ì •ì  ê³µê°ì„ ì ì ˆíˆ ì‚¬ìš©í•˜ì‹œëŠ” ê²ƒ ê°™ë„¤ìš”.</p>
                    <p>ë‹¤ì–‘í•œ ê´€ì ì—ì„œ ë¬¸ì œë¥¼ ë°”ë¼ë³¼ ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì´ ìˆìŠµë‹ˆë‹¤.</p>
                `;
            } else if (score < 80) {
                review = `
                    <p>ê°ì •ì  ê³µê° ëŠ¥ë ¥ì´ ë›°ì–´ë‚˜ë©°, ë‹¤ë¥¸ ì‚¬ëŒì˜ ê°ì •ì„ ì˜ ì´í•´í•˜ì‹­ë‹ˆë‹¤.</p>
                    <p>ë…¼ë¦¬ì  íŒë‹¨ë„ ê°€ëŠ¥í•˜ì§€ë§Œ, ê°ì •ì  ìš”ì†Œë¥¼ ë” ì¤‘ìš”í•˜ê²Œ ê³ ë ¤í•˜ì‹œëŠ” í¸ì…ë‹ˆë‹¤.</p>
                    <p>ì¸ê°„ê´€ê³„ì—ì„œ ë›°ì–´ë‚œ ëŠ¥ë ¥ì„ ë°œíœ˜í•˜ì‹¤ ê²ƒ ê°™ë„¤ìš”.</p>
                `;
            } else {
                review = `
                    <p>ë§¤ìš° ë›°ì–´ë‚œ ê°ì •ì  ê³µê° ëŠ¥ë ¥ì„ ê°€ì§€ê³  ê³„ì‹­ë‹ˆë‹¤.</p>
                    <p>ë‹¤ë¥¸ ì‚¬ëŒì˜ ê°ì •ì„ ê¹Šì´ ì´í•´í•˜ê³  ë°°ë ¤í•˜ëŠ” ì„±í–¥ì´ ë§¤ìš° ê°•í•©ë‹ˆë‹¤.</p>
                    <p>ì¸ê°„ê´€ê³„ì—ì„œ íƒì›”í•œ ëŠ¥ë ¥ì„ ë³´ì—¬ì£¼ì‹¤ ê²ƒ ê°™ë„¤ìš”.</p>
                `;
            }
            return review;
        }

        // í‚¤ì›Œë“œ ë¶„ì„ ë§‰ëŒ€ ê·¸ë˜í”„ ìƒì„± - ê°œì„ ëœ ë²„ì „
        function createKeywordChart(keywordData) {
            const chartContainer = document.getElementById('keywordChart');
            
            // ì•ˆì „í•œ ë°ì´í„° ì²´í¬
            if (!chartContainer) {
                console.error('keywordChart ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!keywordData || typeof keywordData !== 'object') {
                console.warn('í‚¤ì›Œë“œ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:', keywordData);
                keywordData = {};
            }
            
            // ì¹´í…Œê³ ë¦¬ ì •ì˜
            const categories = {
                'logical_thinking': {
                    title: 'ğŸ§  ë…¼ë¦¬ì  ì‚¬ê³ ',
                    description: 'Logical Thinking',
                    color: 'linear-gradient(90deg, #ff6b6b, #ff8e53)',
                    data: keywordData.logical_thinking || {}
                },
                'analytical_approach': {
                    title: 'ğŸ“Š ë¶„ì„ì  ì ‘ê·¼',
                    description: 'Analytical Approach', 
                    color: 'linear-gradient(90deg, #ffa726, #ffcc02)',
                    data: keywordData.analytical_approach || {}
                },
                'emotional_empathy': {
                    title: 'ğŸ’ ê°ì •ì  ê³µê°',
                    description: 'Emotional Empathy',
                    color: 'linear-gradient(90deg, #4ecdc4, #44a08d)',
                    data: keywordData.emotional_empathy || {}
                },
                'relationship_focus': {
                    title: 'ğŸ¤ ê´€ê³„ ì¤‘ì‹¬',
                    description: 'Relationship Focus',
                    color: 'linear-gradient(90deg, #a78bfa, #c084fc)',
                    data: keywordData.relationship_focus || {}
                }
            };
            
            // ëª¨ë“  ì¹´í…Œê³ ë¦¬ì˜ í‚¤ì›Œë“œ ê°œìˆ˜ ìˆ˜ì§‘
            let allCounts = [];
            Object.values(categories).forEach(category => {
                const counts = Object.values(category.data);
                allCounts = allCounts.concat(counts);
            });
            
            const maxCount = Math.max(...allCounts, 1);
            const hasData = allCounts.length > 0 && Math.max(...allCounts) > 0;
            
            let chartHTML = '<div class="keyword-chart">';
            
            if (hasData) {
                // ê° ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì°¨íŠ¸ ìƒì„±
                Object.entries(categories).forEach(([key, category]) => {
                    const usedKeywords = Object.entries(category.data).filter(([keyword, count]) => count > 0);
                    
                    if (usedKeywords.length > 0) {
                        // ì¹´í…Œê³ ë¦¬ë³„ ì´ ì‚¬ìš©ëŸ‰ ê³„ì‚°
                        const totalCount = usedKeywords.reduce((sum, [keyword, count]) => sum + count, 0);
                        
                        chartHTML += `
                            <div class="keyword-category">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                                    <h4 style="margin: 0; color: #2c3e50;">${category.title}</h4>
                                    <span style="font-size: 0.9em; color: #666; font-weight: normal;">ì´ ${totalCount}íšŒ</span>
                                </div>
                                <div style="margin-bottom: 0.5rem; font-size: 0.85em; color: #777;">${category.description}</div>
                                ${usedKeywords
                                    .sort(([,a], [,b]) => b - a) // ì‚¬ìš© íšŸìˆ˜ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                                    .map(([keyword, count]) => `
                                    <div class="keyword-bar-container">
                                        <div class="keyword-label">${keyword}</div>
                                        <div class="keyword-bar-bg">
                                            <div class="keyword-bar" style="width: ${(count / maxCount) * 100}%; background: ${category.color};">
                                                <div class="keyword-count">${count}</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                });
                
                // í†µê³„ ìš”ì•½ - ì•ˆì „í•œ ë°©ë²•
                const safeSum = (obj) => {
                    try {
                        return Object.values(obj || {}).reduce((a, b) => a + b, 0) || 0;
                    } catch (e) {
                        return 0;
                    }
                };
                
                const logicalCount = safeSum(categories.logical_thinking.data) + safeSum(categories.analytical_approach.data);
                const emotionalCount = safeSum(categories.emotional_empathy.data) + safeSum(categories.relationship_focus.data);
                
                chartHTML += `
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #007bff;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #2c3e50;">ğŸ“ˆ í‚¤ì›Œë“œ ì‚¬ìš© íŒ¨í„´</h4>
                        <div style="display: flex; justify-content: space-around; text-align: center;">
                            <div>
                                <div style="font-size: 1.2em; font-weight: bold; color: #ff6b6b;">${logicalCount}</div>
                                <div style="font-size: 0.9em; color: #666;">ë…¼ë¦¬/ë¶„ì„í˜•</div>
                            </div>
                            <div style="font-size: 1.5em; color: #ddd;">vs</div>
                            <div>
                                <div style="font-size: 1.2em; font-weight: bold; color: #4ecdc4;">${emotionalCount}</div>
                                <div style="font-size: 0.9em; color: #666;">ê°ì •/ê´€ê³„í˜•</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                chartHTML += `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <div style="font-size: 2em; margin-bottom: 1rem;">ğŸ“</div>
                        <p style="font-size: 1.1em; margin-bottom: 0.5rem;">ë¶„ì„í•  í‚¤ì›Œë“œê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</p>
                        <p style="font-size: 0.9em; color: #999;">ë” êµ¬ì²´ì ì´ê³  ìƒì„¸í•œ ë‹µë³€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                    </div>
                `;
            }
            
            chartHTML += '</div>';
            chartContainer.innerHTML = chartHTML;
        }

        // CSS ìŠ¤íƒ€ì¼ ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = `
            .review-section {
                margin-bottom: 2rem;
                padding: 1rem;
                background: #f8f9fa;
                border-radius: 8px;
            }
            
            .review-section h3 {
                margin-top: 0;
                color: #2c3e50;
            }
            
            .emotion-bars {
                margin-top: 1rem;
            }
            
            .emotion-bar {
                display: flex;
                align-items: center;
                margin-bottom: 0.5rem;
            }
            
            .emotion-label {
                width: 80px;
                font-weight: bold;
            }
            
            .emotion-bar-container {
                flex-grow: 1;
                height: 20px;
                background: #eee;
                border-radius: 10px;
                margin: 0 10px;
                overflow: hidden;
            }
            
            .emotion-bar-fill {
                height: 100%;
                background: #4CAF50;
                border-radius: 10px;
                transition: width 0.3s ease;
            }
            
            .emotion-score {
                width: 60px;
                text-align: right;
            }
            
            .communication-suggestions {
                list-style-type: none;
                padding: 0;
            }
            
            .communication-suggestions li {
                margin-bottom: 0.5rem;
                padding: 0.5rem;
                background: #fff;
                border-radius: 4px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
        `;
        document.head.appendChild(style);

        // ë™ì  ë¡œë”© ì  ì• ë‹ˆë©”ì´ì…˜
        let loadingInterval = null;
        function startLoadingDots() {
            const dots = document.getElementById('loadingDots');
            let count = 0;
            if (loadingInterval) clearInterval(loadingInterval);
            loadingInterval = setInterval(() => {
                count = (count + 1) % 4;
                dots.textContent = '.'.repeat(count === 0 ? 3 : count);
            }, 400);
        }
        function stopLoadingDots() {
            if (loadingInterval) clearInterval(loadingInterval);
            document.getElementById('loadingDots').textContent = '';
        }
    </script>
</body>
</html> 